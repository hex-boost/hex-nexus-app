version: '3'

tasks:

  clean:
    summary: Cleans the build directory
    cmds:
      - cmd: cmd.exe /c "taskkill /F /IM dlv.exe /T 2>nul || exit /b 0"
  #      - cmd: cmd.exe /c "if exist frontend\\node_modules rmdir /s /q frontend\\node_modules"

  build:
    summary: Builds the application for Windows
    cmds:
      # Execute frontend tasks sequentially
      - task: install:frontend:deps
      - task: prepare:frontend:dist
      - task: generate:bindings
      - task: generate:bindings:updater
      - task: build:frontend
      - task: build:frontend:updater
        vars:
          PRODUCTION: '{{.PRODUCTION}}'
      # Continue with remaining build steps
      - task: mock
      - task: go:mod:tidy
      - task: clean
      - task: generate:icons
      - task: generate:syso
      - cmd: go build -tags production -trimpath -buildvcs=false -ldflags="-X github.com/hex-boost/hex-nexus-app/backend/internal/config.Version={{.VERSION}} -X github.com/hex-boost/hex-nexus-app/backend/internal/config.LogLevel=debug -X github.com/hex-boost/hex-nexus-app/backend/internal/config.BackendURL={{.API_URL}} -X github.com/hex-boost/hex-nexus-app/backend/internal/config.RefreshApiKey={{.REFRESH_API_KEY}} -w -s -H windowsgui" -o bin/Nexus.exe .
      - cmd: go build -tags production -trimpath -buildvcs=false -ldflags="-X github.com/hex-boost/hex-nexus-app/backend/internal/config.Version={{.VERSION}} -X github.com/hex-boost/hex-nexus-app/backend/internal/config.LogLevel=debug -X github.com/hex-boost/hex-nexus-app/backend/internal/config.BackendURL={{.API_URL}} -w -s -H windowsgui" -o bin/updater.exe ./backend/cmd/updater
      - cmd: powershell Remove-item *.syso
    vars:
      BUILD_FLAGS: '{{if eq .PRODUCTION "true"}}-tags production -trimpath -buildvcs=false -ldflags="-w -s -H windowsgui"{{else}}-buildvcs=false -gcflags=all="-l"{{end}}'
    env:
      GOOS: windows
      CGO_ENABLED: 0
      GOARCH: '{{.ARCH | default ARCH}}'
      PRODUCTION: '{{.PRODUCTION | default "false"}}'


  package:
    summary: Packages a production build of the application into a `.exe` bundle
    cmds:
      - task: create:nsis:installer

  generate:syso:
    summary: Generates Windows `.syso` file
    dir: build
    cmds:
      - wails3 generate syso -arch {{.ARCH}} -icon windows/icon.ico -manifest windows/wails.exe.manifest -info windows/info.json -out ../wails_windows_{{.ARCH}}.syso
    vars:
      ARCH: '{{.ARCH | default ARCH}}'

  create:nsis:installer:
    summary: Creates an NSIS installer
    dir: build/windows/nsis
    deps:
      - task: build
        vars:
          PRODUCTION: "true"

    cmds:
      # Create the Microsoft WebView2 bootstrapper if it doesn't exist
      - wails3 generate webview2bootstrapper -dir "{{.ROOT_DIR}}\build\windows\nsis"
      - makensis -DARG_WAILS_{{.ARG_FLAG}}_BINARY="{{.ROOT_DIR}}\{{.BIN_DIR}}\{{.APP_NAME}}.exe" -DVERSION="{{.VERSION}}" project.nsi

    vars:
      ARCH: '{{.ARCH | default ARCH}}'
      ARG_FLAG: '{{if eq .ARCH "amd64"}}AMD64{{else}}ARM64{{end}}'

  run:
    cmds:
      - cmd.exe /c "taskkill /F /IM dlv.exe /T 2>nul || exit /b 0"
      - powershell -Command "while (1) { dlv exec bin/Nexus{{.VERSION}}.exe --headless --listen :2345 --api-version 2 }"
  go:mod:tidy:
    summary: Runs `go mod tidy`
    deps:
      - task: mock
      - task: generate:bindings
      - task: generate:bindings:updater
    internal: true
    cmds:
      - go mod tidy
    method: checksum

  mock:
    summary: Generate Mocks
    deps:
      - task: prepare:frontend:dist
    cmds:
      - cmd: mockery
    generates:
      - backend/**/mocks/*.go
    method: timestamp  # Use timestamp to better track dependencies
    once: true

  prepare:frontend:dist:
    summary: Ensure frontend dist directory exists
    dir: frontend
    cmds:
      - mkdir -p packages/main/dist
      - touch packages/main/dist/index.html
      - mkdir -p ../backend/cmd/updater/dist
      - touch ../backend/cmd/updater/dist/index.html
    once: true

  install:frontend:deps:
    summary: Install frontend dependencies
    dir: frontend
    sources:
      - package.json
      - pnpm-lock.yaml
    generates:
      - node_modules/.pnpm-lock.yaml # Be more specific if possible
    cmds:
      - pnpm store prune
      - pnpm install --frozen-lockfile
    method: checksum



  build:frontend:updater:
    summary: Build the frontend project
    dir: frontend
    sources:
      - "**/*"
    generates:
      - ../backend/cmd/updater/dist/*
    cmds:
      - pnpm {{.BUILD_COMMAND}}
    env:
      NODE_ENV: production
      VITE_APP_VERSION: '{{.VERSION}}'
      VITE_API_URL: '{{.API_URL | default "http://localhost:1337"}}'
    vars:
      BUILD_COMMAND: '{{if eq .PRODUCTION "true"}}build:updater{{else}}dev:updater{{end}}'

  build:frontend:
    summary: Build the frontend project
    dir: frontend
    sources:
      - "**/*"
    generates:
      - packages/main/dist/*
    cmds:
      - pnpm {{.BUILD_COMMAND}}
    env:
      NODE_ENV: production
      VITE_APP_VERSION: '{{.VERSION}}'
      VITE_API_URL: '{{.API_URL | default "http://localhost:1337"}}'
    vars:
      BUILD_COMMAND: '{{if eq .PRODUCTION "true"}}build:main{{else}}dev:main{{end}}'


  generate:bindings:updater:
    summary: Generates bindings for the frontend
    sources:
      - "**/*.go"
      - go.mod
      - go.sum
    generates:
      - frontend/packages/updater/bindings/**/*
    cmds:
      - wails3 generate bindings -names -i -v -ts -f '{{.BUILD_FLAGS}}' -clean=true ./backend/cmd/updater -d frontend/packages/updater/bindings
  generate:bindings:
    summary: Generates bindings for the frontend
    sources:
      - "**/*.go"
      - go.mod
      - go.sum
    generates:
      - frontend/packages/main/bindings/**/*
    cmds:
      - wails3 generate bindings -names -i -v -ts -f '{{.BUILD_FLAGS}}' -clean=true -d frontend/packages/main/bindings .
#-  wails3 generate bindings -names -i -v -ts -clean=true -d frontend/packages/main/bindings
  generate:icons:
    summary: Generates Windows `.ico` and Mac `.icns` files from an image
    dir: build
    sources:
      - "appicon.png"
    generates:
      - "icons.icns"
      - "icons.ico"
    cmds:
      - wails3 generate icons -input appicon.png -windowsfilename windows/icons.ico

  dev:frontend:
    summary: Runs the frontend in development mode
    dir: frontend
    deps:
      - task: install:frontend:deps
    cmds:
      - pnpm dev:main -- --port {{.VITE_PORT}} --strictPort

  update:build-assets:
    summary: Updates the build assets
    dir: build
    cmds:
      - wails3 update build-assets -name "{{.APP_NAME}}" -binaryname "{{.APP_NAME}}" -config config.yml -dir .