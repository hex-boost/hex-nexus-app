version: '3'

tasks:
  go:mod:tidy:
    summary: Runs `go mod tidy`
    deps:
      - task: mock
    internal: true
    cmds:
      - go mod tidy

  mock:
    summary: Generate Mocks
    deps:
      - task: prepare:frontend:dist
    cmds:
      - cmd: mockery

  prepare:frontend:dist:
    summary: Ensure frontend dist directory exists
    dir: frontend
    cmds:
      - mkdir -p packages/main/dist
      - touch packages/main/dist/index.html
      - mkdir -p ../backend/cmd/updater/dist
      - touch ../backend/cmd/updater/dist/index.html

  install:frontend:deps:
    summary: Install frontend dependencies
    dir: frontend
    sources:
      - package.json
      - pnpm-lock.yaml
    generates:
      - node_modules/.pnpm-lock.yaml
    cmds:
      - pnpm store prune
      # Retry logic for pnpm install (using shell commands compatible with Task execution)
      # This example assumes cmd.exe context on Windows if not overridden by shell spec in GHA
      # For GHA, it often defaults to pwsh or bash for 'run' steps.
      # Taskfile itself might use cmd.exe by default on Windows for 'cmd'.
      # Let's make a cmd.exe compatible retry:
      - cmd: |
          @echo off
          setlocal
          set MAX_RETRIES=3
          set RETRY_COUNT=0
          :retry_loop
          pnpm install --frozen-lockfile
          if errorlevel 1 (
            set /a RETRY_COUNT+=1
            if %RETRY_COUNT% LSS %MAX_RETRIES% (
              echo Retrying pnpm install (%RETRY_COUNT%/%MAX_RETRIES%)...
              timeout /t 10 /nobreak >nul
              goto retry_loop
            ) else (
              echo pnpm install failed after %MAX_RETRIES% retries.
              exit /b 1
            )
          ) else (
            echo pnpm install successful.
            exit /b 0
          )
    method: checksum
  build:frontend:updater:
    summary: Build the frontend project
    dir: frontend
    sources:
      - "**/*"
    generates:
      - ../backend/cmd/updater/dist/*
    deps:
      - task: install:frontend:deps
      - task: generate:bindings:updater
      - task: build:frontend # Add dependency here

    cmds:
      - pnpm {{.BUILD_COMMAND}}
    env:
      NODE_ENV: production
      VITE_APP_VERSION: '{{.VERSION}}'
      VITE_API_URL: '{{.API_URL | default "http://localhost:1337"}}'
    vars:
      BUILD_COMMAND: '{{if eq .PRODUCTION "true"}}build:updater{{else}}dev:updater{{end}}'

  build:frontend:
    summary: Build the frontend project
    dir: frontend
    sources:
      - "**/*"
    generates:
      - packages/main/dist/*
    deps:
      - task: install:frontend:deps
      - task: generate:bindings
    cmds:
      - pnpm {{.BUILD_COMMAND}}
    env:
      NODE_ENV: production
      VITE_APP_VERSION: '{{.VERSION}}'
      VITE_API_URL: '{{.API_URL | default "http://localhost:1337"}}'
    vars:
      BUILD_COMMAND: '{{if eq .PRODUCTION "true"}}build:main{{else}}dev:main{{end}}'


  generate:bindings:updater:
    summary: Generates bindings for the frontend
    deps:
      - task: go:mod:tidy
    sources:
      - "**/*.go"
      - go.mod
      - go.sum
    generates:
      - frontend/packages/updater/bindings/**/*
    cmds:
      - wails3 generate bindings -names -i -v -ts -f '{{.BUILD_FLAGS}}' -clean=true ./backend/cmd/updater -d frontend/packages/updater/bindings
  generate:bindings:
    summary: Generates bindings for the frontend
    deps:
      - task: go:mod:tidy
    sources:
      - "**/*.go"
      - go.mod
      - go.sum
    generates:
      - frontend/packages/main/bindings/**/*
    cmds:
      - wails3 generate bindings -names -i -v -ts -f '{{.BUILD_FLAGS}}' -clean=true -d frontend/packages/main/bindings
#-  wails3 generate bindings -names -i -v -ts -clean=true -d frontend/packages/main/bindings
  generate:icons:
    summary: Generates Windows `.ico` and Mac `.icns` files from an image
    dir: build
    sources:
      - "appicon.png"
    generates:
      - "icons.icns"
      - "icons.ico"
    cmds:
      - wails3 generate icons -input appicon.png -windowsfilename windows/icons.ico

  dev:frontend:
    summary: Runs the frontend in development mode
    dir: frontend
    deps:
      - task: install:frontend:deps
    cmds:
      - pnpm dev:main -- --port {{.VITE_PORT}} --strictPort

  update:build-assets:
    summary: Updates the build assets
    dir: build
    cmds:
      - wails3 update build-assets -name "{{.APP_NAME}}" -binaryname "{{.APP_NAME}}" -config config.yml -dir .